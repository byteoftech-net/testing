<!DOCTYPE html>
<script>
  async function getComments(url) {
    try {
      const response = await fetch('https://corsproxy.io/?' + encodeURIComponent(url));
      const html = await response.text();
      const parser = new DOMParser();
      const doc = parser.parseFromString(html, 'text/html');

      const comments = {};

      function parseComment(commentNode, obj) {
        const commentId = commentNode.getAttribute('data-fullname');
        const commentText = commentNode.querySelector('.usertext-body > div > p').textContent.trim();
        const repliesContainer = commentNode.querySelector('.child');

        obj[commentId] = { text: commentText };

        if (repliesContainer) {
          const replies = repliesContainer.querySelectorAll('.comment');
          obj[commentId].replies = {};

          replies.forEach(reply => {
            parseComment(reply, obj[commentId].replies);
          });
        }
      }

      const commentNodes = doc.querySelectorAll('.comment');
      commentNodes.forEach(commentNode => {
        if (!commentNode.parentElement.classList.contains('child')) {
          parseComment(commentNode, comments);
        }
      });

      return JSON.stringify(comments, null, 2);
    } catch (error) {
      console.error('Error:', error);
      return {};
    }
  }
  
fetch('https://corsproxy.io/?' + encodeURIComponent('https://old.reddit.com/r/tearsofthekingdom/')).then(function (response) {
  // The API call was successful!
  return response.text();
}).then(function (html) {
  // Convert the HTML string into a document object
  var parser = new DOMParser();
  var doc = parser.parseFromString(html, 'text/html');

  // Select all post elements
  var postElements = doc.querySelectorAll('.thing.link');

  // Array to store post data
  var postData = [];

  // Loop through each post element
  postElements.forEach(function (post) {
    // Extract relevant information
    var titleElement = post.querySelector('.title');
    var author = post.getAttribute('data-author');
    var authorRank = post.querySelector('.author').classList.contains('moderator') ? 'moderator' : 'regular';
    var subreddit = post.getAttribute('data-subreddit');
    var commentCount = parseInt(post.getAttribute('data-comments-count'));
    var isAnnouncement = post.querySelector('.stickied-tagline') !== null;
    var upvoteCount = parseInt(post.querySelector('.score.likes').textContent);
    var downvoteCount = parseInt(post.querySelector('.score.dislikes').textContent);
    var postUrl = 'https://old.reddit.com' + post.getAttribute('data-permalink');

    // Check if title element and author exist
    if (titleElement && author) {
      var title = titleElement.textContent.trim();
      var timeElement = post.querySelector('time');
      var time = timeElement ? timeElement.getAttribute('datetime') : 'N/A';

      if (postUrl.contains("/comments/")) {
        comments = getComments(postUrl)
      } else {
        comments = {}
      }
      // Create post object
      var postObject = {
        title: title,
        author: author,
        time: time,
        authorRank: authorRank,
        subreddit: subreddit,
        commentCount: commentCount,
        isAnnouncement: isAnnouncement,
        upvoteCount: upvoteCount,
        downvoteCount: downvoteCount,
        url: postUrl,
        comments: comments
      };

      // Push post object to postData array
      postData.push(postObject);
    }
  });

  // Convert postData to JSON and log it
  var jsonData = JSON.stringify(postData, null, 2);
  console.log(jsonData);
}).catch(function (err) {
  // There was an error
  console.error('Something went wrong.', err);
});
</script>
